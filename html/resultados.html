<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Avalia√ß√µes</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-color: #1e1e2f;
        color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container {
        padding-top: 70px;
        max-width: 1200px;
        width: 95%;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-weight: 700;
        color: #ffffff;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6);
        font-size: 1.8rem;
      }
      .charts-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .chart-container {
        flex: 1 1 45%;
        min-width: 300px;
        height: 400px;
        position: relative;
      }
      .chart-container h3 {
        color: #f8f9fa;
        font-weight: 600;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        font-size: 1.2rem;
      }
      canvas {
        background-color: #2c2c3e;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      }
      .legend-canais {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 10px;
        gap: 10px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #f8f9fa;
      }
      .legend-color {
        width: 16px;
        height: 16px;
        margin-right: 5px;
        border-radius: 4px;
        display: inline-block;
      }
      @media (max-width: 768px) {
        .chart-container {
          flex: 1 1 100%;
          height: 300px;
          margin-top: 50px;
        }
        h1 {
          font-size: 1.5rem;
        }
      }
      @media (max-width: 480px) {
        .chart-container {
          height: 250px;
          margin-top: 50px;
        }
        h1 {
          font-size: 1.3rem;
        }
      }
    </style>
  </head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <body>
    <div class="container">
      <h1>Pesquisa de Satisfa√ß√£o</h1>
      <div class="charts-wrapper">
        <!-- Gr√°fico de Notas -->
        <div class="chart-container">
          <h3 class="text-center mb-2">Avalia√ß√µes</h3>
          <canvas id="chartNotas"></canvas>
        </div>
        <!-- Gr√°fico de Canais -->
        <div class="chart-container">
          <h3 class="text-center mb-2">Canais de divulga√ß√µes</h3>
          <canvas id="chartCanais"></canvas>
          <div class="legend-canais" id="legendCanais"></div>
        </div>
      </div>
    </div>
    <div class="container text-center mt-4">
      <button id="exportExcel" class="btn btn-secondary">
        Exportar para Excel
      </button>
    </div>

    <script>
      // === Mapeamento para emojis e labels ===
      const mappingNotas = {
        muito_insatisfeito: "üò° Muito Insatisfeito",
        insatisfeito: "üôÅ Insatisfeito",
        neutro: "üòê Neutro",
        satisfeito: "üôÇ Satisfeito",
        muito_satisfeito: "üòÉ Muito Satisfeito",
      };

      // === Gr√°fico de Notas ===
      const ctxNotas = document.getElementById("chartNotas").getContext("2d");
      const chartNotas = new Chart(ctxNotas, {
        type: "bar",
        data: {
          labels: Object.values(mappingNotas),
          datasets: [
            {
              label: "N√∫mero de Avalia√ß√µes",
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                "#ff4d4d",
                "#ff9f43",
                "#ffd60a",
                "#9eff6e",
                "#00d98f",
              ],
              borderRadius: 10,
              borderSkipped: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1, color: "#f8f9fa" } },
            x: {
              ticks: {
                color: ["#ff4d4d", "#ff9f43", "#ffd60a", "#9eff6e", "#00d98f"],
                font: { size: 16 },
              },
            },
          },
        },
      });

      // === Gr√°fico de Canais ===
      const ctxCanais = document.getElementById("chartCanais").getContext("2d");
      const chartCanais = new Chart(ctxCanais, {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            {
              label: "N√∫mero de Avalia√ß√µes por Canal",
              data: [],
              backgroundColor: [],
              borderRadius: 10,
              borderSkipped: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1, color: "#f8f9fa" } },
            x: { ticks: { color: "#f8f9fa", font: { size: 14 } } },
          },
        },
      });

      const legendCanais = document.getElementById("legendCanais");
      const canalColors = [
        "#ff4d4d",
        "#ff9f43",
        "#ffd60a",
        "#9eff6e",
        "#00d98f",
        "#3399ff",
        "#9966ff",
        "#ff66cc",
        "#66ffcc",
      ];

      // === SSE √∫nico combinando notas e canais ===
      const eventSource = new EventSource(
        "https://pesquisa-satisfacao-925015353452.southamerica-east1.run.app/api/stream-notas"
      );
      // OBS: se no backend voc√™ quiser, pode enviar ambos juntos em stream-notas

      eventSource.onmessage = function (event) {
        const data = JSON.parse(event.data);

        // Atualiza gr√°fico de notas
        const notasData = data.notas || {};
        chartNotas.data.datasets[0].data = Object.keys(mappingNotas).map(
          (k) => notasData[k] || 0
        );
        chartNotas.update();

        // Atualiza gr√°fico de canais
        const canaisData = data.canais || {};
        const labels = Object.keys(canaisData);
        chartCanais.data.labels = labels;
        chartCanais.data.datasets[0].data = Object.values(canaisData);
        chartCanais.data.datasets[0].backgroundColor = labels.map(
          (_, i) => canalColors[i % canalColors.length]
        );
        chartCanais.update();

        // Atualiza legenda de canais
        legendCanais.innerHTML = "";
        labels.forEach((label, i) => {
          const item = document.createElement("div");
          item.className = "legend-item";
          const colorBox = document.createElement("span");
          colorBox.className = "legend-color";
          colorBox.style.backgroundColor = canalColors[i % canalColors.length];
          item.appendChild(colorBox);
          item.appendChild(document.createTextNode(label));
          legendCanais.appendChild(item);
        });
        document.getElementById("exportExcel").addEventListener("click", () => {
          // --- Dados do gr√°fico de notas ---
          const notas = chartNotas.data.datasets[0].data;
          const notasLabels = chartNotas.data.labels;

          const notasSheet = notasLabels.map((label, i) => ({
            Avalia√ß√£o: label,
            Quantidade: notas[i],
          }));

          // --- Dados do gr√°fico de canais ---
          const canais = chartCanais.data.datasets[0].data;
          const canaisLabels = chartCanais.data.labels;

          const canaisSheet = canaisLabels.map((label, i) => ({
            Canal: label,
            Quantidade: canais[i],
          }));

          // --- Criar workbook ---
          const wb = XLSX.utils.book_new();
          const wsNotas = XLSX.utils.json_to_sheet(notasSheet);
          const wsCanais = XLSX.utils.json_to_sheet(canaisSheet);

          XLSX.utils.book_append_sheet(wb, wsNotas, "Avalia√ß√µes");
          XLSX.utils.book_append_sheet(wb, wsCanais, "Canais");

          // --- Salvar arquivo ---
          XLSX.writeFile(wb, "Relatorio_Pesquisa.xlsx");
        });
      };
    </script>
  </body>
</html>
